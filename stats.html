<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Performance – Exam Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>My Performance <span>Overview</span></h1>
    <div class="nav-actions">
      <button class="text" onclick="window.location.href='index.html'">Back to app</button>
      <button id="logoutBtn" class="secondary" style="display:none;">Log out</button>
    </div>
  </header>

  <main>
    <div class="card" id="authCard">
      <div class="section-title">Log in</div>
      <label>Email</label>
      <input id="loginEmail" type="email" />
      <label>Password</label>
      <input id="loginPassword" type="password" />
      <div style="margin-top:0.7rem;">
        <button id="loginBtn" class="primary">Log in</button>
      </div>
      <p id="authStatus" class="muted" style="margin-top:0.4rem;"></p>
    </div>

    <div class="card" id="statsCard" style="display:none;">
      <div class="section-title">Overview</div>
      <div class="card-row">
        <div class="card" style="padding:0.7rem 0.8rem;">
          <div class="muted" style="font-size:0.75rem;">Questions answered</div>
          <div id="statTotal" style="font-size:1.3rem;font-weight:700;">–</div>
        </div>
        <div class="card" style="padding:0.7rem 0.8rem;">
          <div class="muted" style="font-size:0.75rem;">Correct</div>
          <div id="statCorrect" style="font-size:1.3rem;font-weight:700;">–</div>
        </div>
        <div class="card" style="padding:0.7rem 0.8rem;">
          <div class="muted" style="font-size:0.75rem;">Accuracy</div>
          <div id="statAccuracy" style="font-size:1.3rem;font-weight:700;">–</div>
        </div>
        <div class="card" style="padding:0.7rem 0.8rem;">
          <div class="muted" style="font-size:0.75rem;">Avg. time / Q</div>
          <div id="statTime" style="font-size:1.3rem;font-weight:700;">–</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:0.8rem;">Per-exam stats</div>
      <table style="width:100%;border-collapse:collapse;margin-top:0.4rem;">
        <thead>
          <tr>
            <th style="text-align:left;font-size:0.8rem;padding:0.35rem 0.2rem;border-bottom:1px solid #e5e7eb;">Exam</th>
            <th style="text-align:left;font-size:0.8rem;padding:0.35rem 0.2rem;border-bottom:1px solid #e5e7eb;">Answered</th>
            <th style="text-align:left;font-size:0.8rem;padding:0.35rem 0.2rem;border-bottom:1px solid #e5e7eb;">Correct</th>
            <th style="text-align:left;font-size:0.8rem;padding:0.35rem 0.2rem;border-bottom:1px solid #e5e7eb;">Accuracy</th>
            <th style="text-align:left;font-size:0.8rem;padding:0.35rem 0.2rem;border-bottom:1px solid #e5e7eb;">Avg time (s)</th>
          </tr>
        </thead>
        <tbody id="examStatsBody"></tbody>
      </table>

      <p id="statsStatus" class="muted" style="margin-top:0.4rem;"></p>
    </div>
  </main>

  <script>
    const SUPABASE_URL = 'https://xsrbsmjklnigrtmqkbsm.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_d82AZMNDIcPtyJUJECehRw_Rf2ZMfXV';

    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_KEY);

    const authCard = document.getElementById('authCard');
    const statsCard = document.getElementById('statsCard');
    const authStatus = document.getElementById('authStatus');
    const statsStatus = document.getElementById('statsStatus');
    const logoutBtn = document.getElementById('logoutBtn');

    function setStatus(el, msg, good = true) {
      el.textContent = msg;
      el.style.color = good ? '#059669' : '#dc2626';
    }

    async function onAuthChange() {
      const { data } = await client.auth.getUser();
      const user = data?.user || null;

      if (!user) {
        authCard.style.display = 'block';
        statsCard.style.display = 'none';
        logoutBtn.style.display = 'none';
        return;
      }

      authCard.style.display = 'none';
      statsCard.style.display = 'block';
      logoutBtn.style.display = 'inline-block';
      logoutBtn.onclick = async () => {
        await client.auth.signOut();
        onAuthChange();
      };

      await loadStats(user.id);
    }

    client.auth.onAuthStateChange(onAuthChange);
    onAuthChange();

    document.getElementById('loginBtn').onclick = async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!email || !password) {
        setStatus(authStatus, 'Email and password required.', false);
        return;
      }
      const { error } = await client.auth.signInWithPassword({ email, password });
      if (error) setStatus(authStatus, error.message, false);
      else setStatus(authStatus, 'Logged in.', true);
      await onAuthChange();
    };

    async function loadStats(userId) {
      setStatus(statsStatus, 'Loading...', true);

      const { data, error } = await client
        .from('user_answers')
        .select('exam_id, is_correct, time_ms, exams(title)')
        .eq('user_id', userId);

      if (error) {
        console.error(error);
        setStatus(statsStatus, 'Failed to load stats: ' + error.message, false);
        return;
      }

      if (!data || data.length === 0) {
        document.getElementById('statTotal').textContent = '0';
        document.getElementById('statCorrect').textContent = '0';
        document.getElementById('statAccuracy').textContent = '0%';
        document.getElementById('statTime').textContent = '–';
        document.getElementById('examStatsBody').innerHTML = '';
        setStatus(statsStatus, 'No answered questions yet.', true);
        return;
      }

      const total = data.length;
      const correct = data.filter(r => r.is_correct).length;
      const totalTime = data.reduce((sum, r) => sum + (r.time_ms || 0), 0);
      const avgTime = totalTime ? totalTime / total / 1000 : 0;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statCorrect').textContent = correct;
      document.getElementById('statAccuracy').textContent = ((correct / total) * 100).toFixed(1) + '%';
      document.getElementById('statTime').textContent = avgTime ? avgTime.toFixed(1) : '–';

      const byExam = {};
      data.forEach((row) => {
        const id = row.exam_id;
        if (!byExam[id]) {
          byExam[id] = {
            title: row.exams?.title || 'Unknown',
            total: 0,
            correct: 0,
            timeMs: 0
          };
        }
        byExam[id].total += 1;
        if (row.is_correct) byExam[id].correct += 1;
        byExam[id].timeMs += row.time_ms || 0;
      });

      const tbody = document.getElementById('examStatsBody');
      tbody.innerHTML = '';
      Object.values(byExam).forEach((exam) => {
        const acc = exam.total ? ((exam.correct / exam.total) * 100).toFixed(1) + '%' : '–';
        const avg = exam.total && exam.timeMs ? (exam.timeMs / exam.total / 1000).toFixed(1) : '–';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-size:0.82rem;padding:0.3rem 0.2rem;">${exam.title}</td>
          <td style="font-size:0.82rem;padding:0.3rem 0.2rem;">${exam.total}</td>
          <td style="font-size:0.82rem;padding:0.3rem 0.2rem;">${exam.correct}</td>
          <td style="font-size:0.82rem;padding:0.3rem 0.2rem;">${acc}</td>
          <td style="font-size:0.82rem;padding:0.3rem 0.2rem;">${avg}</td>
        `;
        tbody.appendChild(tr);
      });

      setStatus(statsStatus, 'Stats loaded.', true);
    }
  </script>
</body>
</html>
