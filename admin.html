<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin â€“ Question Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Admin <span>Question uploader</span></h1>
    <div class="nav-actions">
      <button class="text" onclick="window.location.href='index.html'">Back to app</button>
      <button id="logoutBtn" class="secondary" style="display:none;">Log out</button>
    </div>
  </header>

  <main>
    <div class="card" id="authCard">
      <div class="section-title">Admin login <span class="badge">Restricted</span></div>
      <label>Email</label>
      <input id="loginEmail" type="email" />
      <label>Password</label>
      <input id="loginPassword" type="password" />
      <div style="margin-top:0.7rem;display:flex;gap:0.5rem;">
        <button id="loginBtn" class="primary">Log in</button>
        <button id="signupBtn" class="secondary">Sign up (first admin)</button>
      </div>
      <p id="authStatus" class="muted" style="margin-top:0.4rem;"></p>
    </div>

    <div class="card" id="builderCard" style="display:none;">
      <div class="section-title">
        Exam & question builder
        <span class="badge">Up to 6 answer choices</span>
      </div>
      <p class="muted" style="margin-top:0;">Select an existing exam or create a new one.</p>

      <label>Exam</label>
      <div style="display:grid;grid-template-columns:1.2fr 1fr;gap:0.6rem;">
        <select id="examSelect"></select>
        <input id="newExamTitle" placeholder="New exam title (optional)" />
      </div>
      <label style="margin-top:0.4rem;">Exam description (for new exam)</label>
      <input id="newExamDescription" placeholder="Short description" />

      <hr style="margin:0.8rem 0;border:none;border-top:1px solid #e5e7eb;">

      <label>Question text</label>
      <textarea id="questionText" rows="4" style="width:100%;border-radius:12px;border:1px solid #d1d5db;padding:0.5rem;"></textarea>

      <label style="margin-top:0.4rem;">Image URL (optional, ECG/X-ray etc.)</label>
      <input id="mediaUrl" placeholder="https://..." />

      <label style="margin-top:0.4rem;">General explanation (optional)</label>
      <textarea id="generalExplanation" rows="3" style="width:100%;border-radius:12px;border:1px solid #d1d5db;padding:0.5rem;"></textarea>

      <div class="section-title" style="margin-top:0.8rem;">Answers</div>
      <p class="muted" style="margin-top:0;">Leave unused slots completely blank. Pick exactly one correct answer.</p>
      <div id="answersContainer"></div>

      <div style="margin-top:0.8rem;display:flex;justify-content:flex-end;gap:0.5rem;">
        <button id="clearBtn" class="secondary">Clear form</button>
        <button id="saveBtn" class="primary">Save question</button>
      </div>
      <p id="saveStatus" class="muted" style="margin-top:0.4rem;"></p>
    </div>
  </main>

  <script>
    const SUPABASE_URL = 'https://xsrbsmjklnigrtmqkbsm.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_d82AZMNDIcPtyJUJECehRw_Rf2ZMfXV';

    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_KEY);

    // ONLY these emails are admins
    const ADMIN_EMAILS = [
      'zaidusama2001@gmail.com'  // <- replace this with your real email
    ];

    const authCard = document.getElementById('authCard');
    const builderCard = document.getElementById('builderCard');
    const authStatus = document.getElementById('authStatus');
    const logoutBtn = document.getElementById('logoutBtn');
    const examSelect = document.getElementById('examSelect');
    const saveStatus = document.getElementById('saveStatus');

    function setStatus(el, msg, good = true) {
      el.textContent = msg;
      el.style.color = good ? '#059669' : '#dc2626';
    }

    async function onAuthChange() {
      const { data } = await client.auth.getUser();
      const user = data?.user || null;

      if (!user) {
        authCard.style.display = 'block';
        builderCard.style.display = 'none';
        logoutBtn.style.display = 'none';
        authStatus.textContent = '';
        return;
      }

      const email = user.email || '';
      if (!ADMIN_EMAILS.includes(email)) {
        authCard.style.display = 'block';
        builderCard.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        setStatus(authStatus, 'Logged in but not admin (email not allowed).', false);
        logoutBtn.onclick = async () => {
          await client.auth.signOut();
          onAuthChange();
        };
        return;
      }

      authCard.style.display = 'none';
      builderCard.style.display = 'block';
      logoutBtn.style.display = 'inline-block';
      logoutBtn.onclick = async () => {
        await client.auth.signOut();
        onAuthChange();
      };
      authStatus.textContent = '';
      await loadExams();
    }

    client.auth.onAuthStateChange(onAuthChange);
    onAuthChange();

    document.getElementById('loginBtn').onclick = async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!email || !password) {
        setStatus(authStatus, 'Email and password required.', false);
        return;
      }
      const { error } = await client.auth.signInWithPassword({ email, password });
      if (error) setStatus(authStatus, error.message, false);
      else setStatus(authStatus, 'Logged in.', true);
      await onAuthChange();
    };

    document.getElementById('signupBtn').onclick = async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!email || !password) {
        setStatus(authStatus, 'Email and password required.', false);
        return;
      }
      const { error } = await client.auth.signUp({ email, password });
      if (error) setStatus(authStatus, error.message, false);
      else setStatus(authStatus, 'Sign-up OK. Check your email and then log in.', true);
    };

    async function loadExams() {
      const { data, error } = await client
        .from('exams')
        .select('id, title')
        .order('created_at', { ascending: true });

      if (error) {
        console.error(error);
        setStatus(saveStatus, 'Failed to load exams: ' + error.message, false);
        return;
      }

      examSelect.innerHTML = '';
      const none = document.createElement('option');
      none.value = '';
      none.textContent = 'Select existing exam (or enter new title)';
      examSelect.appendChild(none);

      (data || []).forEach((exam) => {
        const opt = document.createElement('option');
        opt.value = exam.id;
        opt.textContent = exam.title;
        examSelect.appendChild(opt);
      });
    }

    // Build answer slots
    const answersContainer = document.getElementById('answersContainer');
    function buildAnswerSlots() {
      answersContainer.innerHTML = '';
      for (let i = 0; i < 6; i++) {
        const wrap = document.createElement('div');
        wrap.style.marginBottom = '0.5rem';
        wrap.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.2rem;">
            <span class="muted">Option ${String.fromCharCode(65 + i)}</span>
            <label style="font-size:0.8rem;display:flex;align-items:center;gap:0.25rem;">
              <input type="radio" name="correctOption" value="${i}"> Correct
            </label>
          </div>
          <textarea class="answer-text" data-index="${i}" rows="2"
            style="width:100%;border-radius:12px;border:1px solid #d1d5db;padding:0.4rem;"
            placeholder="Answer text"></textarea>
          <textarea class="answer-expl" data-index="${i}" rows="2"
            style="width:100%;border-radius:12px;border:1px solid #e5e7eb;margin-top:0.2rem;padding:0.4rem;font-size:0.8rem;"
            placeholder="Explanation for why this is correct or incorrect"></textarea>
        `;
        answersContainer.appendChild(wrap);
      }
    }
    buildAnswerSlots();

    document.getElementById('clearBtn').onclick = () => {
      document.getElementById('questionText').value = '';
      document.getElementById('mediaUrl').value = '';
      document.getElementById('generalExplanation').value = '';
      document.getElementById('newExamTitle').value = '';
      document.getElementById('newExamDescription').value = '';
      answersContainer.querySelectorAll('.answer-text').forEach((el) => el.value = '');
      answersContainer.querySelectorAll('.answer-expl').forEach((el) => el.value = '');
      document.querySelectorAll('input[name="correctOption"]').forEach((el) => el.checked = false);
      saveStatus.textContent = '';
    };

    document.getElementById('saveBtn').onclick = async () => {
      saveStatus.textContent = '';

      let examId = examSelect.value || null;
      const newTitle = document.getElementById('newExamTitle').value.trim();
      const newDesc = document.getElementById('newExamDescription').value.trim();

      if (!examId && !newTitle) {
        setStatus(saveStatus, 'Select an exam or enter a new title.', false);
        return;
      }

      if (!examId && newTitle) {
        const { data, error } = await client
          .from('exams')
          .insert({ title: newTitle, description: newDesc || null })
          .select('id')
          .single();
        if (error) {
          console.error(error);
          setStatus(saveStatus, 'Failed to create exam: ' + error.message, false);
          return;
        }
        examId = data.id;
        await loadExams();
        examSelect.value = examId;
      }

      const qText = document.getElementById('questionText').value.trim();
      if (!qText) {
        setStatus(saveStatus, 'Question text is required.', false);
        return;
      }

      const mediaUrl = document.getElementById('mediaUrl').value.trim() || null;
      const generalExplanation = document.getElementById('generalExplanation').value.trim() || null;

      const correctRadio = document.querySelector('input[name="correctOption"]:checked');
      if (!correctRadio) {
        setStatus(saveStatus, 'Select which option is correct.', false);
        return;
      }
      const correctIndex = parseInt(correctRadio.value, 10);

      const answerTexts = Array.from(document.querySelectorAll('.answer-text'));
      const answerExpls = Array.from(document.querySelectorAll('.answer-expl'));
      const answers = [];

      answerTexts.forEach((textEl) => {
        const idx = parseInt(textEl.dataset.index, 10);
        const txt = textEl.value.trim();
        if (!txt) return;
        const expl = answerExpls.find((e) => parseInt(e.dataset.index, 10) === idx)?.value.trim() || null;
        answers.push({
          choice_index: idx,
          choice_text: txt,
          explanation: expl,
          is_correct: idx === correctIndex
        });
      });

      if (answers.length < 2) {
        setStatus(saveStatus, 'Provide at least two answer choices.', false);
        return;
      }

      try {
        setStatus(saveStatus, 'Saving...', true);

        const { data: qData, error: qError } = await client
          .from('questions')
          .insert({
            exam_id: examId,
            text: qText,
            media_url: mediaUrl,
            general_explanation: generalExplanation
          })
          .select('id')
          .single();

        if (qError) {
          console.error(qError);
          setStatus(saveStatus, 'Failed to save question: ' + qError.message, false);
          return;
        }

        const qId = qData.id;

        const { error: aError } = await client
          .from('answers')
          .insert(
            answers.map((a) => ({ ...a, question_id: qId }))
          );

        if (aError) {
          console.error(aError);
          setStatus(saveStatus, 'Question saved but answers failed: ' + aError.message, false);
          return;
        }

        setStatus(saveStatus, 'Question + answers saved successfully.', true);
      } catch (err) {
        console.error(err);
        setStatus(saveStatus, 'Unexpected error: ' + err.message, false);
      }
    };
  </script>
</body>
</html>
